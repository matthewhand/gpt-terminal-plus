<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - GPT Terminal Plus</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; min-height: 100vh; display: flex; flex-direction: column; }
        .header { padding: 1rem; border-bottom: 1px solid #ddd; background: #fff; }
        .chat-area { flex: 1; padding: 1rem; overflow-y: auto; }
        .message { margin-bottom: 1rem; padding: 1rem; border-radius: 8px; }
        .message.user { background: #007acc; color: white; margin-left: 2rem; }
        .message.assistant { background: #f8f9fa; border: 1px solid #e9ecef; margin-right: 2rem; }
        .input-area { padding: 1rem; border-top: 1px solid #ddd; background: #fff; }
        .input-group { display: flex; gap: 0.5rem; }
        input[type="text"] { flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; }
        .btn { background: #007acc; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #005a9e; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .disabled-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .disabled-message { background: white; padding: 2rem; border-radius: 8px; text-align: center; max-width: 400px; }
        .status { padding: 0.5rem; margin-bottom: 1rem; border-radius: 4px; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ’¬ Chat Interface</h1>
            <div id="status"></div>
        </div>
        
        <div class="chat-area" id="chatArea">
            <div class="message assistant">
                <strong>Assistant:</strong> Hello! I'm ready to help you. What would you like to know?
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Type your message..." disabled>
                <button class="btn" id="sendBtn" disabled>Send</button>
                <button class="btn" id="streamBtn" disabled>Stream</button>
            </div>
        </div>
    </div>

    <div id="disabledOverlay" class="disabled-overlay" style="display: none;">
        <div class="disabled-message">
            <h3>ðŸ¤– LLM Not Configured</h3>
            <p>Chat functionality requires LLM configuration.</p>
            <p><a href="/llm-setup.html">Configure LLM Settings</a> to enable chat features.</p>
        </div>
    </div>

    <script>
        const API_TOKEN = localStorage.getItem('apiToken') || prompt('Enter API Token:');
        if (API_TOKEN) localStorage.setItem('apiToken', API_TOKEN);

        const headers = { 'Authorization': `Bearer ${API_TOKEN}`, 'Content-Type': 'application/json' };
        const chatArea = document.getElementById('chatArea');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const streamBtn = document.getElementById('streamBtn');
        const statusEl = document.getElementById('status');
        const disabledOverlay = document.getElementById('disabledOverlay');

        let messages = [];

        function showStatus(message, type = 'info') {
            statusEl.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusEl.innerHTML = '', 5000);
        }

        function addMessage(role, content) {
            messages.push({ role, content });
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            messageEl.innerHTML = `<strong>${role === 'user' ? 'You' : 'Assistant'}:</strong> ${content}`;
            chatArea.appendChild(messageEl);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        async function checkLLMStatus() {
            try {
                const response = await fetch('/model', { headers });
                
                if (response.status === 409) {
                    // LLM disabled
                    disabledOverlay.style.display = 'flex';
                    messageInput.disabled = true;
                    sendBtn.disabled = true;
                    streamBtn.disabled = true;
                    showStatus('LLM functionality is disabled. Configure LLM settings to enable chat.', 'error');
                    return false;
                } else if (response.ok) {
                    // LLM enabled
                    disabledOverlay.style.display = 'none';
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    streamBtn.disabled = false;
                    showStatus('LLM is configured and ready.', 'info');
                    return true;
                } else {
                    showStatus('Error checking LLM status: ' + response.statusText, 'error');
                    return false;
                }
            } catch (error) {
                showStatus('Network error: ' + error.message, 'error');
                return false;
            }
        }

        async function sendMessage(stream = false) {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage('user', message);
            messageInput.value = '';
            sendBtn.disabled = true;
            streamBtn.disabled = true;

            try {
                if (stream) {
                    await sendStreamMessage();
                } else {
                    await sendRegularMessage();
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                sendBtn.disabled = false;
                streamBtn.disabled = false;
            }
        }

        async function sendRegularMessage() {
            const response = await fetch('/chat/completions', {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    messages: messages,
                    stream: false
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            const content = data.choices?.[0]?.message?.content || 'No response';
            addMessage('assistant', content);
        }

        async function sendStreamMessage() {
            const response = await fetch('/chat/completions', {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    messages: messages,
                    stream: true
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let content = '';

            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant';
            messageEl.innerHTML = '<strong>Assistant:</strong> ';
            const contentEl = document.createElement('span');
            messageEl.appendChild(contentEl);
            chatArea.appendChild(messageEl);

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') return;
                            
                            try {
                                const parsed = JSON.parse(data);
                                const delta = parsed.choices?.[0]?.delta?.content;
                                if (delta) {
                                    content += delta;
                                    contentEl.textContent = content;
                                    chatArea.scrollTop = chatArea.scrollHeight;
                                }
                            } catch (e) {
                                // Ignore parse errors for non-JSON lines
                            }
                        }
                    }
                }
            } finally {
                messages.push({ role: 'assistant', content });
            }
        }

        // Event listeners
        sendBtn.addEventListener('click', () => sendMessage(false));
        streamBtn.addEventListener('click', () => sendMessage(true));
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(false);
            }
        });

        // Check LLM status on load and periodically
        checkLLMStatus();
        setInterval(checkLLMStatus, 30000); // Check every 30 seconds
    </script>
</body>
</html>