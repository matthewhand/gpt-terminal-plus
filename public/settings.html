<!DOCTYPE html>
<html>
<head>
    <title>GPT Terminal Plus - Settings</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .panel { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .panel h3 { margin-top: 0; }
        input, select, textarea { width: 100%; padding: 5px; margin: 5px 0; }
        button { padding: 10px 20px; margin: 5px; }
        #preview { background: #f5f5f5; padding: 10px; white-space: pre-wrap; }
    </style>
    <style>
      :root { --bg:#0b1220; --fg:#e5e7eb; --muted:#94a3b8; --card:#0f172a; --border:#213047; --accent:#6366f1; --accent-fg:#fff; }
      [data-theme="light"] { --bg:#ffffff; --fg:#0f172a; --muted:#475569; --card:#f8fafc; --border:#e5e7eb; --accent:#6366f1; --accent-fg:#fff; }
      body { background: var(--bg); color: var(--fg); }
      .panel { background: var(--card); border-color: var(--border); }
      h1, h3 { color: var(--fg); }
      input, select, textarea { background: var(--card); color: var(--fg); border:1px solid var(--border); }
      button { background: var(--accent); color: var(--accent-fg); border: none; }
      #preview { background: #0a1020; color: var(--fg); border: 1px solid var(--border); }
    </style>
</head>
<body>
    <h1>GPT Terminal Plus Settings</h1>
    <label style="display:inline-flex;align-items:center;gap:.5rem;">
      <input type="checkbox" id="themeToggle" checked /> Dark Mode
    </label>
    
    <div class="panel">
        <h3>LLM Engine</h3>
        <select id="llmEngine">
            <option value="codex">Codex</option>
            <option value="interpreter">Interpreter</option>
            <option value="ollama">Ollama</option>
        </select>
        
        <div id="codexPanel" style="display:none;">
            <input id="codexModel" placeholder="Model (e.g., gpt-4)" />
            <label><input type="checkbox" id="codexFullAuto" /> Full Auto</label>
        </div>
        
        <div id="interpreterPanel" style="display:none;">
            <input id="interpreterModel" placeholder="Model (e.g., gpt-4o)" />
            <label><input type="checkbox" id="interpreterAutoRun" /> Auto Run</label>
            <input id="interpreterTemp" type="number" step="0.1" placeholder="Temperature" />
        </div>
        
        <div id="ollamaPanel" style="display:none;">
            <input id="ollamaModel" placeholder="Model (e.g., llama2)" />
            <input id="ollamaHost" placeholder="Host (e.g., http://localhost:11434)" />
        </div>
    </div>
    
    <div class="panel">
        <h3>API Token</h3>
        <input id="apiToken" type="text" placeholder="[REDACTED]" />
        <button type="button" onclick="generateKey()">Generate Random Key</button>
    </div>
    
    <div class="panel">
        <h3>General Settings</h3>
        <label><input type="checkbox" id="localhost" /> Localhost Only</label>
        <input id="maxInputChars" type="number" placeholder="Max Input Chars" />
        <input id="maxOutputChars" type="number" placeholder="Max Output Chars" />
        <input id="maxCost" type="number" step="0.01" placeholder="Max LLM Cost USD" />
    </div>
    
    <div class="panel">
        <h3>Advanced JSON Override</h3>
        <textarea id="jsonOverride" rows="10" placeholder="Enter JSON configuration..."></textarea>
    </div>
    
    <button onclick="saveConfig()">Save Configuration</button>
    <button onclick="loadConfig()">Load Current</button>
    
    <div class="panel">
        <h3>Live OpenAPI Preview</h3>
        <div id="preview">Loading...</div>
    </div>

    <script>
        // Theme (dark by default)
        (function(){
          const key='gpt_theme';
          const saved = localStorage.getItem(key) || 'dark';
          const apply = (t) => { document.documentElement.setAttribute('data-theme', t==='light' ? 'light':'dark'); localStorage.setItem(key,t); const tg=document.getElementById('themeToggle'); if (tg) tg.checked = (t!=='light'); };
          apply(saved);
          document.getElementById('themeToggle')?.addEventListener('change', (e)=>apply(e.target.checked?'dark':'light'));
        })();
        let token = localStorage.getItem('authToken') || prompt('Enter auth token:');
        
        document.getElementById('llmEngine').onchange = function() {
            document.querySelectorAll('[id$="Panel"]').forEach(p => p.style.display = 'none');
            document.getElementById(this.value + 'Panel').style.display = 'block';
        };
        
        function generateKey() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            let key = "";
            for (let i = 0; i < 32; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('apiToken').value = key;
        }
        
        async function saveConfig() {
            const config = {
                LLM_ENGINE: document.getElementById('llmEngine').value,
                CODEX_MODEL: document.getElementById('codexModel').value,
                CODEX_FULL_AUTO: document.getElementById('codexFullAuto').checked,
                INTERPRETER_MODEL: document.getElementById('interpreterModel').value,
                INTERPRETER_AUTO_RUN: document.getElementById('interpreterAutoRun').checked,
                INTERPRETER_TEMPERATURE: parseFloat(document.getElementById('interpreterTemp').value) || 0.7,
                OLLAMA_MODEL: document.getElementById('ollamaModel').value,
                OLLAMA_HOST: document.getElementById('ollamaHost').value,
                MAX_INPUT_CHARS: parseInt(document.getElementById('maxInputChars').value) || 10000,
                MAX_OUTPUT_CHARS: parseInt(document.getElementById('maxOutputChars').value) || 100000,
                MAX_LLM_COST_USD: parseFloat(document.getElementById('maxCost').value) || 0,
            };
            
            const apiToken = document.getElementById('apiToken').value.trim();
            if (apiToken && apiToken !== '[REDACTED]') {
                config.API_TOKEN = apiToken;
            }
            
            const override = document.getElementById('jsonOverride').value;
            if (override) Object.assign(config, JSON.parse(override));
            
            const res = await fetch('/config/override', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
            
            if (res.ok && apiToken && apiToken !== '[REDACTED]') {
                localStorage.setItem('authToken', apiToken);
                token = apiToken;
            }
            
            alert(res.ok ? 'Saved!' : 'Error saving config');
        }
        
        async function loadConfig() {
            const res = await fetch('/config/settings', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const settings = await res.json();
            // Show [REDACTED] if API token exists
            document.getElementById('apiToken').placeholder = settings.API_TOKEN ? '[REDACTED]' : 'Enter API token';
            
            document.getElementById('llmEngine').onchange();
        }
        
        async function updatePreview() {
            try {
                const res = await fetch('/config/schema', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const schema = await res.json();
                document.getElementById('preview').textContent = JSON.stringify(schema, null, 2);
            } catch (err) {
                document.getElementById('preview').textContent = 'Error loading schema';
            }
        }
        
        loadConfig();
        updatePreview();
        setInterval(updatePreview, 5000);
    </script>
</body>
</html>
