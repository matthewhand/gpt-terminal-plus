<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Server Settings (Redacted)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1216;
      --fg: #e6edf3;
      --muted: #9aa4af;
      --card: #151a21;
      --accent: #2f81f7;
      --danger: #f85149;
      --border: #2d333b;
      --ok: #3fb950;
      --ro: #ffa657;
      --code: #1b2129;
    }
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: var(--bg); color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
    }
    header {
      padding: 16px 20px; border-bottom: 1px solid var(--border); background: #0c0f13;
    }
    header h1 {
      margin: 0; font-size: 18px; letter-spacing: 0.3px;
    }
    main {
      padding: 20px; max-width: 1100px; margin: 0 auto;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    label { display: inline-flex; align-items: center; gap: 8px; }
    input[type="password"], input[type="text"] {
      background: #0c0f13; color: var(--fg);
      border: 1px solid var(--border); border-radius: 6px;
      padding: 8px 10px; min-width: 320px;
      font-family: inherit;
    }
    input[type="checkbox"] { transform: translateY(1px); }
    button {
      background: var(--accent); color: white;
      border: 0; border-radius: 6px; padding: 8px 12px; margin-left: 8px;
      cursor: pointer; font-weight: 600;
    }
    button.secondary { background: transparent; color: var(--fg); border: 1px solid var(--border); }
    .status { margin-top: 8px; font-size: 13px; color: var(--muted); }
    .error { color: var(--danger); }
    .ok { color: var(--ok); }
    details.group { margin-top: 14px; }
    details.group summary {
      cursor: pointer; font-weight: 600;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
      font-size: 14px;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      text-align: left; padding: 8px 6px; vertical-align: top;
    }
    th { color: var(--muted); font-weight: 600; }
    code {
      background: var(--code); color: var(--fg);
      padding: 2px 6px; border-radius: 4px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .badge {
      display: inline-block; padding: 2px 6px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border);
    }
    .badge.ro { color: var(--ro); border-color: var(--ro); }
    .badge.rw { color: var(--ok); border-color: var(--ok); }
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .spacer { flex: 1 1 auto; }
    .muted { color: var(--muted); }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
    .note { font-size: 13px; color: var(--muted); margin-top: 8px; }
    pre.raw {
      background: var(--code); border: 1px solid var(--border); border-radius: 6px;
      padding: 12px; overflow: auto; max-height: 420px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Server Settings (Redacted)</h1>
  </header>
  <main>
    <section class="panel">
      <div class="controls">
        <label>API Token:
          <input type="password" id="token" placeholder="Paste API_TOKEN" autocomplete="off" />
        </label>
        <label><input type="checkbox" id="remember" /> Remember token</label>
        <button id="loadBtn">Load settings</button>
        <button id="clearBtn" class="secondary">Clear</button>
        <span class="spacer"></span>
        <button id="rawToggle" class="secondary">Show raw JSON</button>
      </div>
      <div class="note">
        This page calls <code>/settings</code> with a Bearer token and displays a redacted view.
        Secrets (e.g., OpenAI API keys) are masked, and values provided by environment variables are marked <span class="badge ro">read-only</span>.
      </div>
      <div id="status" class="status"></div>
    </section>

    <section id="content" class="panel" hidden>
      <h3 style="margin-top: 0;">Settings</h3>
      <div id="groups"></div>
      <details id="raw" class="raw" style="margin-top:12px;" hidden>
        <summary>Raw JSON</summary>
        <pre class="raw" id="rawJson"></pre>
      </details>
    </section>

    <section id="executorsPanel" class="panel" hidden>
      <h3 style="margin-top: 0;">Executors</h3>
      <div class="controls">
        <label>Exposure Mode:
          <select id="exposureMode">
            <option value="generic">generic (execute-shell)</option>
            <option value="specific">specific (execute-&lt;name&gt;)</option>
            <option value="both">both</option>
            <option value="none">none</option>
          </select>
        </label>
        <button id="saveExposure">Save</button>
        <span class="spacer"></span>
        <button id="reloadExecutors" class="secondary">Reload</button>
      </div>
      <div id="executorsStatus" class="status"></div>
      <div id="executors"></div>
    </section>

    <section id="llmPanel" class="panel" hidden>
      <h3 style="margin-top: 0;">LLM Configuration</h3>
      <div class="controls">
        <label>Provider:
          <select id="llmProvider">
            <option value="">Disabled</option>
            <option value="openai">OpenAI</option>
            <option value="ollama">Ollama</option>
            <option value="lmstudio">LM Studio</option>
            <option value="open-interpreter">Open Interpreter</option>
          </select>
        </label>
        <button id="testLLM">Test Connection</button>
        <span class="spacer"></span>
        <button id="reloadLLM" class="secondary">Reload</button>
      </div>
      <div id="llmStatus" class="status"></div>

      <div id="llmConfig" style="margin-top: 16px;">
        <div class="grid">
          <div>
            <label>Base URL:
              <input type="text" id="llmBaseUrl" placeholder="https://api.openai.com/v1" />
            </label>
          </div>
          <div>
            <label>API Key:
              <input type="password" id="llmApiKey" placeholder="sk-..." />
            </label>
          </div>
          <div>
            <label>Default Model:
              <input type="text" id="llmModel" placeholder="gpt-3.5-turbo" />
            </label>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <button id="saveLLM">Save LLM Settings</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    (function() {
      const $ = (id) => document.getElementById(id);
      const tokenInput = $('token');
      const remember = $('remember');
      const loadBtn = $('loadBtn');
      const clearBtn = $('clearBtn');
      const rawToggle = $('rawToggle');
      const statusEl = $('status');
      const content = $('content');
      const groupsEl = $('groups');
      const rawDetails = $('raw');
      const rawJson = $('rawJson');

      // Helpers
      function setStatus(msg, cls) {
        statusEl.textContent = msg || '';
        statusEl.className = 'status' + (cls ? ' ' + cls : '');
      }
      function readUrlToken() {
        try {
          const usp = new URLSearchParams(location.search);
          if (usp.has('token')) return usp.get('token');
          if (location.hash && location.hash.startsWith('#token=')) {
            return decodeURIComponent(location.hash.slice('#token='.length));
          }
        } catch {}
        return null;
      }
      function saveTokenMaybe() {
        if (remember.checked) localStorage.setItem('settings_api_token', tokenInput.value || '');
        else localStorage.removeItem('settings_api_token');
      }
      function loadSavedToken() {
        const saved = localStorage.getItem('settings_api_token');
        if (saved) { tokenInput.value = saved; remember.checked = true; }
      }
      function humanValue(val) {
        if (val === null) return 'null';
        if (typeof val === 'object') return JSON.stringify(val);
        if (val === '') return '(empty)';
        return String(val);
      }
      function renderTable(groupName, entries) {
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th style="width:38%;">Key</th><th style="width:42%;">Value</th><th style="width:20%;">Access</th></tr>';
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        Object.entries(entries).forEach(([key, meta]) => {
          const tr = document.createElement('tr');
          const tdK = document.createElement('td');
          const tdV = document.createElement('td');
          const tdR = document.createElement('td');

          tdK.innerHTML = '<code>' + groupName + '.' + key + '</code>';
          tdV.textContent = humanValue(meta.value);
          tdR.innerHTML = meta.readOnly
            ? '<span class="badge ro" title="Provided by environment variable; not editable here.">read-only</span>'
            : '<span class="badge rw" title="Not provided by environment; editable in file-based config (future).">writable*</span>';

          tr.appendChild(tdK);
          tr.appendChild(tdV);
          tr.appendChild(tdR);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        return table;
      }
      function renderGroups(payload) {
        groupsEl.innerHTML = '';
        Object.entries(payload).forEach(([groupName, entries]) => {
          const details = document.createElement('details');
          details.className = 'group';
          details.open = true;
          const summary = document.createElement('summary');
          summary.textContent = groupName;
          details.appendChild(summary);
          details.appendChild(renderTable(groupName, entries));
          groupsEl.appendChild(details);
        });
      }

      async function loadSettings() {
        setStatus('Loading...', '');
        content.hidden = true;
        rawDetails.hidden = true;
        rawJson.textContent = '';

        const token = tokenInput.value.trim();
        if (!token) {
          setStatus('API token is required.', 'error');
          return;
        }

        try {
          const res = await fetch('/settings', {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (!res.ok) {
            const text = await res.text();
            setStatus('Request failed: ' + res.status + ' ' + text, 'error');
            return;
          }
          const payload = await res.json();
          renderGroups(payload);
          rawJson.textContent = JSON.stringify(payload, null, 2);
          setStatus('Loaded.', 'ok');
          content.hidden = false;
          saveTokenMaybe();
          await loadExecutors();
          await loadLLMSettings();
        } catch (err) {
          setStatus('Network error: ' + (err && err.message ? err.message : err), 'error');
        }
      }

      async function loadExecutors() {
        const token = tokenInput.value.trim();
        const setExecStatus = (msg, cls) => {
          const el = document.getElementById('executorsStatus');
          el.textContent = msg || '';
          el.className = 'status' + (cls ? ' ' + cls : '');
        };
        setExecStatus('Loading executors...', '');
        const panel = document.getElementById('executorsPanel');
        const listEl = document.getElementById('executors');
        listEl.innerHTML = '';
        try {
          const res = await fetch('/command/executors', { headers: { 'Authorization': 'Bearer ' + token } });
          if (!res.ok) {
            setExecStatus('Failed to load executors: ' + res.status, 'error');
            return;
          }
          const payload = await res.json();
          const execs = payload.executors || [];

          // Render each executor row
          execs.forEach((ex) => {
            const row = document.createElement('div');
            row.className = 'grid';

            const left = document.createElement('div');
            left.innerHTML = '<strong>' + ex.name + '</strong> <span class="badge">' + ex.kind + '</span>';

            const enabledBox = document.createElement('div');
            enabledBox.innerHTML = '<label><input type="checkbox" ' + (ex.enabled ? 'checked' : '') + ' /> Enabled</label>';
            const enabledInput = enabledBox.querySelector('input');
            enabledInput.addEventListener('change', async () => {
              try {
                await fetch('/command/executors/' + ex.name + '/toggle', {
                  method: 'POST',
                  headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ enabled: enabledInput.checked })
                });
                setExecStatus('Updated executor ' + ex.name, 'ok');
              } catch (e) { setExecStatus('Failed to toggle: ' + e.message, 'error'); }
            });

            const cmdBox = document.createElement('div');
            cmdBox.innerHTML = '<label>cmd: <input type="text" value="' + (ex.cmd || '') + '" /></label>';
            const cmdInput = cmdBox.querySelector('input');

            const argsBox = document.createElement('div');
            argsBox.innerHTML = '<label>args: <input type="text" value="' + (ex.args || []).join(' ') + '" placeholder="space separated" /></label>';
            const argsInput = argsBox.querySelector('input');

            const actions = document.createElement('div');
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.addEventListener('click', async () => {
              const args = argsInput.value.trim() ? argsInput.value.trim().split(/\s+/) : [];
              try {
                await fetch('/command/executors/' + ex.name + '/update', {
                  method: 'POST',
                  headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                  body: JSON.stringify({ cmd: cmdInput.value, args })
                });
                setExecStatus('Saved executor ' + ex.name, 'ok');
              } catch (e) { setExecStatus('Failed to save: ' + e.message, 'error'); }
            });
            const testBtn = document.createElement('button');
            testBtn.textContent = 'Test';
            testBtn.className = 'secondary';
            testBtn.addEventListener('click', async () => {
              try {
                const r = await fetch('/command/executors/' + ex.name + '/test', {
                  method: 'POST', headers: { 'Authorization': 'Bearer ' + token }
                });
                const body = await r.json();
                setExecStatus('Test ' + ex.name + ': status=' + r.status + ' exit=' + (body.status ?? 'n/a'), r.ok ? 'ok' : 'error');
              } catch (e) { setExecStatus('Failed to test: ' + e.message, 'error'); }
            });
            actions.appendChild(saveBtn);
            actions.appendChild(testBtn);

            row.appendChild(left);
            row.appendChild(enabledBox);
            row.appendChild(cmdBox);
            row.appendChild(argsBox);
            row.appendChild(actions);
            listEl.appendChild(row);
          });

          // Load exposure mode via /settings redacted config
          try {
            const res2 = await fetch('/settings', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res2.ok) {
              const red = await res2.json();
              const val = (((red || {}).executors || {}).exposureMode || {}).value || 'generic';
              const sel = document.getElementById('exposureMode');
              sel.value = val;
            }
          } catch {}

          panel.hidden = false;
          setExecStatus('Loaded executors.', 'ok');
        } catch (e) {
          setExecStatus('Network error: ' + e.message, 'error');
        }
      }

      async function saveExposureMode() {
        const token = tokenInput.value.trim();
        const mode = (document.getElementById('exposureMode') as HTMLSelectElement).value;
        const setExecStatus = (msg, cls) => {
          const el = document.getElementById('executorsStatus');
          el.textContent = msg || '';
          el.className = 'status' + (cls ? ' ' + cls : '');
        };
        try {
          const res = await fetch('/config/override', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ executors: { exposureMode: mode } })
          });
          if (res.ok) setExecStatus('Updated exposure mode to ' + mode, 'ok');
          else setExecStatus('Failed to update exposure: ' + res.status, 'error');
        } catch (e) { setExecStatus('Network error: ' + e.message, 'error'); }
      }

      async function loadLLMSettings() {
        const token = tokenInput.value.trim();
        const setLLMStatus = (msg, cls) => {
          const el = document.getElementById('llmStatus');
          el.textContent = msg || '';
          el.className = 'status' + (cls ? ' ' + cls : '');
        };
        setLLMStatus('Loading LLM settings...', '');
        const panel = document.getElementById('llmPanel');
        try {
          const res = await fetch('/settings', { headers: { 'Authorization': 'Bearer ' + token } });
          if (!res.ok) {
            setLLMStatus('Failed to load LLM settings: ' + res.status, 'error');
            return;
          }
          const payload = await res.json();
          const llm = payload.llm || {};

          // Set provider
          const providerEl = document.getElementById('llmProvider');
          providerEl.value = (llm.provider || {}).value || '';

          // Set other fields
          document.getElementById('llmBaseUrl').value = (llm.openai?.baseUrl || {}).value || (llm.ollama?.baseUrl || {}).value || '';
          document.getElementById('llmApiKey').value = (llm.openai?.apiKey || {}).value || '';
          document.getElementById('llmModel').value = (llm.model || {}).value || '';

          panel.hidden = false;
          setLLMStatus('Loaded LLM settings.', 'ok');
        } catch (e) {
          setLLMStatus('Network error: ' + e.message, 'error');
        }
      }

      async function testLLMConnection() {
        const token = tokenInput.value.trim();
        const setLLMStatus = (msg, cls) => {
          const el = document.getElementById('llmStatus');
          el.textContent = msg || '';
          el.className = 'status' + (cls ? ' ' + cls : '');
        };
        setLLMStatus('Testing LLM connection...', '');
        try {
          const res = await fetch('/model', { headers: { 'Authorization': 'Bearer ' + token } });
          if (res.ok) {
            setLLMStatus('LLM connection successful!', 'ok');
          } else {
            setLLMStatus('LLM connection failed: ' + res.status, 'error');
          }
        } catch (e) {
          setLLMStatus('LLM test error: ' + e.message, 'error');
        }
      }

      async function saveLLMSettings() {
        const token = tokenInput.value.trim();
        const setLLMStatus = (msg, cls) => {
          const el = document.getElementById('llmStatus');
          el.textContent = msg || '';
          el.className = 'status' + (cls ? ' ' + cls : '');
        };
        const provider = document.getElementById('llmProvider').value;
        const baseUrl = document.getElementById('llmBaseUrl').value;
        const apiKey = document.getElementById('llmApiKey').value;
        const model = document.getElementById('llmModel').value;

        const config = { llm: { provider } };
        if (baseUrl) config.llm.openai = { baseUrl };
        if (apiKey) config.llm.openai = { ...config.llm.openai, apiKey };
        if (model) config.llm.model = model;

        try {
          const res = await fetch('/config/override', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
          });
          if (res.ok) {
            setLLMStatus('LLM settings saved successfully!', 'ok');
          } else {
            setLLMStatus('Failed to save LLM settings: ' + res.status, 'error');
          }
        } catch (e) {
          setLLMStatus('Network error: ' + e.message, 'error');
        }
      }

      // Wire events
      loadBtn.addEventListener('click', loadSettings);
      clearBtn.addEventListener('click', () => {
        tokenInput.value = '';
        setStatus('');
        content.hidden = true;
        rawDetails.hidden = true;
        rawJson.textContent = '';
        saveTokenMaybe();
      });
      rawToggle.addEventListener('click', () => {
        rawDetails.hidden = !rawDetails.hidden;
        rawToggle.textContent = rawDetails.hidden ? 'Show raw JSON' : 'Hide raw JSON';
      });
      remember.addEventListener('change', saveTokenMaybe);
      document.getElementById('reloadExecutors').addEventListener('click', loadExecutors);
      document.getElementById('saveExposure').addEventListener('click', saveExposureMode);
      document.getElementById('reloadLLM').addEventListener('click', loadLLMSettings);
      document.getElementById('testLLM').addEventListener('click', testLLMConnection);
      document.getElementById('saveLLM').addEventListener('click', saveLLMSettings);
      tokenInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') loadSettings();
      });

      // Bootstrap: prefill from URL hash/query or localStorage
      const urlToken = readUrlToken();
      if (urlToken) tokenInput.value = urlToken;
      loadSavedToken();
      if (tokenInput.value) {
        // Auto-load once if token present
        loadSettings();
      }
    })();
  </script>
</body>
</html>
